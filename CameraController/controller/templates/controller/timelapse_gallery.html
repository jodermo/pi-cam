{% extends "controller/base.html" %}

{% block title %}Timelapse Gallery{% endblock %}

{% block content %}
<div class="timelapse-container">

  <!-- Viewer Card -->
  <section class="card timelapse-viewer">
    <div class="player">
      <canvas id="timelapse-canvas"></canvas>
      <div id="frame-timestamp" class="frame-timestamp"></div>
    </div>
  </section>

</div>
{% block actions %}
<div class="player-controls">
  <div class="action-group">
    <button id="play-pause" class="btn-action">Play</button>
    <label for="speed-number">Speed (ms/frame):</label>
  </div>
  <div class="action-group">
  <input id="speed-number" type="number" min="25" value="500" class="input-field speed-input" />
  <input id="speed-slider" type="range" min="25" max="2000" step="50" value="500" class="speed-slider" />
 </div>

  <button id="open-tl-settings" class="btn-action">
    <span class="icon">&#9881;</span>
    Settings
  </button>
  <form method="post" action="{% url 'download_timelapse' %}" id="download-tl-form" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="speed_ms" id="download-speed" value="{{ timelapse_speed_ms }}">
    <button type="submit" class="btn-action">
      <span class="icon">&#x1f4be;</span>
      Download Video
    </button>
  </form>

</div>
{% endblock %}
<!-- Timelapse Settings Modal -->
<div id="timelapse-settings-modal" class="modal" aria-hidden="true">
  <div class="modal-wrapper">
    <div class="modal-header">
      <button class="modal-close" id="close-tl-settings">&times;</button>
      <h2 class="card-title">Timelapse Settings</h2>
    </div>
    <div class="modal-content">
      <form method="post" class="settings-grid">
        {% csrf_token %}
        {% for field in form.visible_fields %}
        <div class="setting-row">
          <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
          </div>
          <div class="form-group">
            {% if field.help_text %}<small class="muted">{{ field.help_text }}</small>{% endif %}
            {% for err in field.errors %}<div class="error">{{ err }}</div>{% endfor %}
          </div>
        </div>
        {% endfor %}
        <div class="setting-row form-actions">
          <div class="form-group">
            <button type="submit" class="btn-action">Save Settings</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-backdrop"></div>
</div>
{% endblock %}

{% block navigation %}
<div class="app-navigation timelapse-navigation">

  <div class="thumbnail-container">
    <!-- Nav buttons must live INSIDE the scrolling .thumbnails -->
    <div class="thumbnails">
      {% for url in images reversed %}
        <img
          class="thumb"
          data-index="{{ forloop.counter0 }}"
          data-src="{{ url }}"
          src="{{ url }}?{{ forloop.counter0 }}"
          alt="Frame {{ forloop.counter }}"
        />
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
;(function(){
  // Elements
  const canvas      = document.getElementById('timelapse-canvas');
  const tsEl        = document.getElementById('frame-timestamp');
  const ctx         = canvas.getContext('2d');
  const playBtn     = document.getElementById('play-pause');
  const speedNum    = document.getElementById('speed-number');
  const speedSlider = document.getElementById('speed-slider');
  const canvasWidth = 1920;
  const canvasHeight = 1080;

  // Thumbnails & URLs
  const strip       = document.querySelector('.thumbnail-container .thumbnails');
  const thumbs      = Array.from(strip.querySelectorAll('.thumb'));
  const urls        = thumbs.map(t => t.dataset.src);
  let idx = 0, timer = null;

  function resizeCanvas(){
    canvas.width  = canvasWidth;
    canvas.height = canvasHeight;
  }

  function formatTimestampFromFilename(src) {
    const name = src.split('/').pop().split('.')[0];
    const m = name.match(/(\d{4})(\d{2})(\d{2})[_-](\d{2})(\d{2})(\d{2})/);
    if (!m) return '';
    const [ , Y, Mo, D, H, Mi, S ] = m.map(Number);
    return new Date(Y, Mo - 1, D, H, Mi, S).toLocaleString();
  }

  function drawFrame(i){
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
    img.src = urls[i];
    tsEl.textContent = formatTimestampFromFilename(urls[i]);
    thumbs.forEach(t => t.classList.toggle('active', +t.dataset.index === i));
  }

  function scrollActiveIntoView(){
    const active = thumbs[idx];
    if (active) active.scrollIntoView({ behavior: 'smooth', inline: 'center' });
  }

  function play(){
    timer = setInterval(() => {
      idx = (idx + 1) % urls.length;
      drawFrame(idx);
      scrollActiveIntoView();
    }, +speedNum.value);
    playBtn.textContent = 'Pause';
  }

  function pause(){
    clearInterval(timer);
    timer = null;
    playBtn.textContent = 'Play';
  }

  // Bind play/pause & speed controls
  playBtn.onclick = () => timer ? pause() : play();
  speedNum.oninput    = () => { speedSlider.value = speedNum.value; if(timer){ pause(); play(); } };
  speedSlider.oninput = () => { speedNum.value = speedSlider.value; if(timer){ pause(); play(); } };

  // Thumbnail click
  thumbs.forEach(t => {
    t.onclick = () => {
      idx = +t.dataset.index;
      drawFrame(idx);
      pause();
      scrollActiveIntoView();
    };
  });


  const downloadSpeed = document.getElementById('download-speed');
  speedNum.addEventListener('input', () => {
    downloadSpeed.value = speedNum.value;
  });
  // Modal toggle
  const tlModal = document.getElementById('timelapse-settings-modal');
  document.getElementById('open-tl-settings').onclick  = () => tlModal.setAttribute('aria-hidden','false');
  document.getElementById('close-tl-settings').onclick = () => tlModal.setAttribute('aria-hidden','true');
  tlModal.querySelector('.modal-backdrop').onclick     = () => tlModal.setAttribute('aria-hidden','true');

  // Init
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
  drawFrame(0);
})();
</script>
{% endblock %}
