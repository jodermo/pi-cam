{% extends "controller/base.html" %}
{% load static %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="â€¦" crossorigin="anonymous"/>
<style>
  .media-container { max-width: 1200px; margin: auto; padding: 1rem; }
  .gallery.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px,1fr)); gap:1rem; }
  .gallery.list-view { display:block; }
  .gallery.list-view .gallery-item { display:flex; align-items:center; gap:1rem; padding:0.5rem; }
  .gallery-item { position: relative; background:#fff; border:1px solid #ddd; border-radius:4px; overflow:hidden; }
  .gallery-item img, .gallery-item video { width:100%; display:block; }
  .gallery.list-view .gallery-item img, .gallery.list-view .gallery-item video { width:120px; flex-shrink:0; }
  .item-controls { position:absolute; top:8px; right:8px; display:flex; gap:0.25rem; }
  .item-controls a, .item-controls button { background:rgba(255,255,255,0.9); border:none; padding:0.25rem; border-radius:4px; cursor:pointer; }
  .actions-card { background:#f7f7f7; padding:0.75rem; border-radius:4px; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem; }
  .actions-card .spacer { flex:1; }
  .btn-action { display:inline-flex; align-items:center; gap:0.25rem; }
  .btn-action.disabled, .btn-action:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-action.active { background:#007bff; color:#fff; }
</style>
{% endblock %}

{% block title %}Media Browser{% endblock %}

{% block navigation %}
<div class="card navigation-card span-2">
  <div class="navigation-grid tabs" role="tablist">
    <button class="tab active" data-target="photos">Photos</button>
    <button class="tab" data-target="videos">Videos</button>
    <button class="tab" data-target="timelapse">Timelapse</button>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="media-container">
  {% comment %} PHOTOS {% endcomment %}
  <section id="photos" class="tab-content active" role="tabpanel">
    <div class="actions-card">
      <div class="layout-controls">
        <button id="photos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="photos-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="photos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    </div>
    <div id="photos-gallery" class="gallery grid-view">
      {% for photo in photos %}
      <div class="gallery-item" data-filename="{{ photo.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ photo.url }}" alt="{{ photo.filename }}">
        <div class="item-controls">
          <a href="{{ photo.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_photo' filename=photo.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No photos.</p>
      {% endfor %}
    </div>
  </section>

  {% comment %} VIDEOS {% endcomment %}
  <section id="videos" class="tab-content" role="tabpanel" hidden>
    <div class="actions-card">
      <div class="layout-controls">
        <button id="videos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="videos-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="videos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    </div>
    <div id="videos-gallery" class="gallery grid-view">
      {% for video in videos %}
      <div class="gallery-item" data-filename="{{ video.filename }}">
        <input type="checkbox" class="select-item">
        <video src="{{ video.url }}" controls></video>
        <div class="item-controls">
          <a href="{{ video.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_video' filename=video.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No videos.</p>
      {% endfor %}
    </div>
  </section>

  {% comment %} TIMELAPSE {% endcomment %}
  <section id="timelapse" class="tab-content" role="tabpanel" hidden>
    <div class="actions-card">
      <div class="layout-controls">
        <button id="tl-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="tl-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="tl-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    </div>
    <div id="tl-gallery" class="gallery grid-view">
      {% for tl in timelapses %}
      <div class="gallery-item" data-filename="{{ tl.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ tl.url }}" alt="{{ tl.filename }}">
        <div class="item-controls">
          <a href="{{ tl.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_timelapse' filename=tl.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No timelapse frames.</p>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
;(function(){
  // TAB SWITCHING
  document.querySelectorAll('.navigation-grid .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      // toggle tab button
      document.querySelectorAll('.navigation-grid .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      // show correct section
      const target = tab.dataset.target;
      document.querySelectorAll('.tab-content').forEach(s=> s.hidden = s.id!==target);
    });
  });

  // For each section: layout toggles, per-item delete/download, batch delete
  ['photos','videos','tl'].forEach(prefix=>{
    const gridBtn = document.getElementById(`${prefix}-grid`),
          listBtn = document.getElementById(`${prefix}-list`),
          gallery = document.getElementById(`${prefix}-gallery`),
          delSel  = document.getElementById(`${prefix}-delete-selected`);

    // layout toggle
    gridBtn.addEventListener('click', ()=> {
      gallery.classList.replace('list-view','grid-view');
      gridBtn.classList.add('active');
      listBtn.classList.remove('active');
    });
    listBtn.addEventListener('click', ()=> {
      gallery.classList.replace('grid-view','list-view');
      listBtn.classList.add('active');
      gridBtn.classList.remove('active');
    });

    // per-item delete
    gallery.querySelectorAll('.delete-item').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const url = btn.dataset.url;
        if(!confirm('Delete this item?')) return;
        const res = await fetch(url, { method:'DELETE', headers:{ 'X-CSRFToken':'{{ csrf_token }}' }});
        if(res.ok) btn.closest('.gallery-item').remove();
      });
    });

    // batch select/delete
    const checkboxes = gallery.querySelectorAll('.select-item');
    function updateBatch() {
      delSel.disabled = ![...checkboxes].some(c=>c.checked);
    }
    checkboxes.forEach(c=> c.addEventListener('change', updateBatch));
    delSel.addEventListener('click', async ()=>{
      if(!confirm('Delete selected items?')) return;
      const filenames = [...checkboxes].filter(c=>c.checked).map(c=>c.closest('.gallery-item').dataset.filename);
      const api = {
        photos: '{% url "api_photo_list" %}',
        videos: '{% url "api_video_list" %}',
        tl:     '{% url "api_timelapse_list" %}'
      }[prefix];
      const res = await fetch(api, {
        method:'DELETE',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':'{{ csrf_token }}'
        },
        body: JSON.stringify({ filenames })
      });
      if(res.ok) window.location.reload();
    });
  });
})();
</script>
{% endblock %}
