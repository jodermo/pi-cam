{% extends "controller/base.html" %}
{% load static %}

{% block title %}Timelapse Gallery{% endblock %}

{% block content %}

<h1>Timelapse Gallery</h1>

<form method="post" class="form-panel">
  {% csrf_token %}
  <div class="form-grid">
    {% for field in form.visible_fields %}
      <div>
        {{ field.label_tag }}
        {{ field }}
        {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
        {% for err in field.errors %}<div class="error">{{ err }}</div>{% endfor %}
      </div>
    {% endfor %}
    <div>
      <button type="submit">Save Settings</button>
    </div>
  </div>
</form>

<section class="timelapse-viewer">
  <div class="player">
    <canvas id="timelapse-canvas"></canvas>
    <div class="player-controls">
      <button id="play-pause">Play</button>
      <label for="speed-number">Speed (ms/frame):</label>
      <input id="speed-number" type="number" min="25" value="500" />
      <label for="speed-slider">Adjust Speed:</label>
      <input id="speed-slider" type="range" min="25" max="2000" step="50" value="500" />
    </div>
  </div>

  <div class="thumbnail-container">
    <button class="thumb-nav prev">&laquo;</button>
    <div class="thumbnails">
      {% for url in images reversed %}
        <img class="thumb" data-index="{{ forloop.counter0 }}" src="{{ url }}?{{ forloop.counter0 }}" alt="frame {{ forloop.counter }}" />
      {% endfor %}
    </div>
    <button class="thumb-nav next">&raquo;</button>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const urls = [{% for url in images reversed %}"{{ url }}?{{ forloop.counter0 }}",{% endfor %}];
    const canvas = document.getElementById('timelapse-canvas');
    const ctx = canvas.getContext('2d');
    const playBtn = document.getElementById('play-pause');
    const speedNum = document.getElementById('speed-number');
    const speedSlider = document.getElementById('speed-slider');
    const thumbs = Array.from(document.querySelectorAll('.thumb'));
    const thumbStrip = document.querySelector('.thumbnails');
    let idx = 0, timer = null;

    function resizeCanvas(){
      const w = canvas.parentElement.clientWidth;
      canvas.width = w;
      canvas.height = w * 3/4;
    }
    function drawFrame(i){
      const img = new Image();
      img.onload = ()=> {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0,0,canvas.width,canvas.height);
      };
      img.src = urls[i];
      thumbs.forEach(t=> t.classList.toggle('active', +t.dataset.index===i));
    }
    function play(){
      timer = setInterval(()=>{
        idx = (idx+1) % urls.length;
        drawFrame(idx);
      }, +speedNum.value);
      playBtn.textContent = 'Pause';
    }
    function pause(){
      clearInterval(timer);
      timer = null;
      playBtn.textContent = 'Play';
    }
    playBtn.onclick = ()=> timer ? pause() : play();

    // sync number and slider
    speedNum.oninput = ()=> {
      speedSlider.value = speedNum.value;
      if(timer){ pause(); play(); }
    };
    speedSlider.oninput = ()=> {
      speedNum.value = speedSlider.value;
      if(timer){ pause(); play(); }
    };

    thumbs.forEach(t=>{
      t.onclick = ()=> {
        idx = +t.dataset.index;
        drawFrame(idx);
      };
    });

    document.querySelector('.thumb-nav.prev').onclick = ()=> {
      thumbStrip.scrollBy({ left: -thumbStrip.clientWidth, behavior: 'smooth' });
    };
    document.querySelector('.thumb-nav.next').onclick = ()=> {
      thumbStrip.scrollBy({ left: thumbStrip.clientWidth, behavior: 'smooth' });
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    drawFrame(0);
  })();
</script>
{% endblock %}