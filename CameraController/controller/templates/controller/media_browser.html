{% extends "controller/base.html" %}
{% load static %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="â€¦" crossorigin="anonymous"/>
<style>
  .media-container { max-width:1200px; margin:auto; padding:1rem; }
  .gallery.grid-view { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:1rem; }
  .gallery.list-view { display:block; }
  .gallery.list-view .gallery-item {
    display:flex; align-items:center; gap:1rem; padding:0.5rem;
    border:1px solid #ddd; border-radius:4px; margin-bottom:0.5rem;
  }
  .gallery-item { position:relative; background:#fff; border:1px solid #ddd; border-radius:4px; overflow:hidden; }
  .gallery-item img, .gallery-item video { width:100%; display:block; }
  .gallery.list-view .gallery-item img,
  .gallery.list-view .gallery-item video { width:120px; flex-shrink:0; }
  .item-controls {
    position:absolute; top:8px; right:8px; display:flex; gap:0.25rem;
  }
  .item-controls a, .item-controls button {
    background:rgba(255,255,255,0.9); border:none; padding:0.25rem; border-radius:4px; cursor:pointer;
  }
  .actions-card {
    background:#f7f7f7; padding:.75rem; border-radius:4px; margin-bottom:1rem;
    display:flex; align-items:center; flex-wrap:wrap; gap:.5rem;
  }
  .actions-card .layout-controls { display:flex; gap:.5rem; }
  .actions-card .batch-controls { display:flex; gap:.5rem; }
  .actions-card .spacer { flex:1; }
  .btn-action { display:inline-flex; align-items:center; gap:.25rem; }
  .btn-action.disabled, .btn-action:disabled { opacity:.5; cursor:not-allowed; }
  .btn-action.active { background:#007bff; color:#fff; }

  /* Modal preview */
  .modal {
    display:none; position:fixed; z-index:1000;
    left:0; top:0; width:100%; height:100%; overflow:auto;
    background:rgba(0,0,0,0.8);
  }
  .modal-content {
    margin:5% auto; max-width:80%; position:relative;
  }
  .modal-content img, .modal-content video {
    width:100%; height:auto; display:block;
    border-radius:4px;
  }
  .modal-close {
    position:absolute; top:8px; right:12px; font-size:2rem;
    color:#fff; cursor:pointer;
  }
</style>
{% endblock %}

{% block title %}Media Browser{% endblock %}

{% block navigation %}
<div class="card navigation-card span-2">
  <div class="navigation-grid tabs" role="tablist">
    <button class="tab active" data-target="photos">Photos</button>
    <button class="tab" data-target="videos">Videos</button>
    <button class="tab" data-target="timelapse">Timelapse</button>
  </div>
</div>
{% endblock %}

{% block actions %}
{# PHOTOS #}
<section id="photosActions" class="tab-content active">
  <div class="actions-card">
    <div class="layout-controls">
      <button id="photos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
      <button id="photos-list" class="btn-action"><i class="fas fa-list"></i></button>
    </div>
    <div class="batch-controls">
      <button id="photos-select-all" class="btn-action"><i class="fas fa-check-square"></i> Select All</button>
      <button id="photos-unselect-all" class="btn-action"><i class="fas fa-square"></i> Unselect All</button>
    </div>
    <div class="spacer"></div>
    <button id="photos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    <form id="photos-download-selected-form" method="post" action="{% url 'download_selected_photos' %}">
      {% csrf_token %}
      <div class="selected-inputs"></div>
      <button id="photos-download-selected" type="button" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
    </form>
    <form method="post" action="{% url 'download_all_photos' %}">
      {% csrf_token %}
      <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
    </form>
    <button id="photos-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
  </div>
</section>

{# VIDEOS #}
<section id="videosActions" class="tab-content" hidden>
  <div class="actions-card">
    <div class="layout-controls">
      <button id="videos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
      <button id="videos-list" class="btn-action"><i class="fas fa-list"></i></button>
    </div>
    <div class="batch-controls">
      <button id="videos-select-all" class="btn-action"><i class="fas fa-check-square"></i> Select All</button>
      <button id="videos-unselect-all" class="btn-action"><i class="fas fa-square"></i> Unselect All</button>
    </div>
    <div class="spacer"></div>
    <button id="videos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    <form id="videos-download-selected-form" method="post" action="{% url 'download_selected_videos' %}">
      {% csrf_token %}
      <div class="selected-inputs"></div>
      <button id="videos-download-selected" type="button" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
    </form>
    <form method="post" action="{% url 'download_all_videos' %}">
      {% csrf_token %}
      <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
    </form>
    <button id="videos-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
  </div>
</section>

{# TIMELAPSE #}
<section id="timelapseActions" class="tab-content" hidden>
  <div class="actions-card">
    <div class="layout-controls">
      <button id="tl-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
      <button id="tl-list" class="btn-action"><i class="fas fa-list"></i></button>
    </div>
    <div class="batch-controls">
      <button id="tl-select-all" class="btn-action"><i class="fas fa-check-square"></i> Select All</button>
      <button id="tl-unselect-all" class="btn-action"><i class="fas fa-square"></i> Unselect All</button>
    </div>
    <div class="spacer"></div>
    <button id="tl-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
    <form id="tl-download-selected-form" method="post" action="{% url 'download_selected_timelapse' %}">
      {% csrf_token %}
      <div class="selected-inputs"></div>
      <button id="tl-download-selected" type="button" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
    </form>
    <form method="post" action="{% url 'download_all_timelapse' %}">
      {% csrf_token %}
      <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
    </form>
    <button id="tl-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="media-container">

  {# PHOTOS #}
  <section id="photos" class="tab-content active">
    <div id="photos-gallery" class="gallery grid-view">
      {% for photo in photos %}
      <div class="gallery-item" data-filename="{{ photo.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ photo.url }}" alt="{{ photo.filename }}">
        <div class="item-controls">
          <button class="btn-action preview-item" data-url="{{ photo.url }}"><i class="fas fa-eye"></i></button>
          <a href="{{ photo.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_photo' filename=photo.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No photos available.</p>
      {% endfor %}
    </div>
  </section>

  {# VIDEOS #}
  <section id="videos" class="tab-content" hidden>
    <div id="videos-gallery" class="gallery grid-view">
      {% for video in videos %}
      <div class="gallery-item" data-filename="{{ video.filename }}">
        <input type="checkbox" class="select-item">
        <video muted>
          <source src="{{ video.url }}" type="video/mp4">
        </video>
        <div class="item-controls">
          <button class="btn-action preview-item" data-url="{{ video.url }}"><i class="fas fa-eye"></i></button>
          <a href="{{ video.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_video' filename=video.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No videos available.</p>
      {% endfor %}
    </div>
  </section>

  {# TIMELAPSE #}
  <section id="timelapse" class="tab-content" hidden>
    <div id="tl-gallery" class="gallery grid-view">
      {% for tl in timelapses %}
      <div class="gallery-item" data-filename="{{ tl.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ tl.url }}" alt="{{ tl.filename }}">
        <div class="item-controls">
          <button class="btn-action preview-item" data-url="{{ tl.url }}"><i class="fas fa-eye"></i></button>
          <a href="{{ tl.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_timelapse' filename=tl.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <p class="muted">No timelapse frames available.</p>
      {% endfor %}
    </div>
  </section>

</div>

<!-- Preview Modal -->
<div id="preview-modal" class="modal">
  <div class="modal-content">
    <span id="preview-close" class="modal-close">&times;</span>
    <img id="preview-img" style="display:none;" alt="Preview">
    <video id="preview-video" controls style="display:none;"></video>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
;(function(){
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

  // --- Tab switching ---
  document.querySelectorAll('.navigation-grid .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.navigation-grid .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(sec=>{
        const show1 = tab.dataset.target;
        const show2 = show1 + 'Actions';
        if (sec.id === show1 || sec.id === show2) {
          sec.classList.add('active'); sec.hidden = false;
        } else {
          sec.classList.remove('active'); sec.hidden = true;
        }
      });
    });
  });

  const apiDeleteAll = {
    photos: '{% url "api_photo_list" %}',
    videos: '{% url "api_video_list" %}',
    tl:     '{% url "api_timelapse_list" %}'
  };

  ['photos','videos','tl'].forEach(prefix=>{
    const gallery         = document.getElementById(prefix+'-gallery'),
          deleteSelBtn    = document.getElementById(prefix+'-delete-selected'),
          downloadSelForm = document.getElementById(prefix+'-download-selected-form'),
          downloadSelBtn  = document.getElementById(prefix+'-download-selected'),
          deleteAllBtn    = document.getElementById(prefix+'-delete-all'),
          selectAllBtn    = document.getElementById(prefix+'-select-all'),
          unselectAllBtn  = document.getElementById(prefix+'-unselect-all'),
          boxes           = gallery.querySelectorAll('.select-item');

    // Layout toggle
    document.getElementById(prefix+'-grid').addEventListener('click', ()=> {
      gallery.classList.replace('list-view','grid-view');
      document.getElementById(prefix+'-grid').classList.add('active');
      document.getElementById(prefix+'-list').classList.remove('active');
    });
    document.getElementById(prefix+'-list').addEventListener('click', ()=> {
      gallery.classList.replace('grid-view','list-view');
      document.getElementById(prefix+'-list').classList.add('active');
      document.getElementById(prefix+'-grid').classList.remove('active');
    });

    // Select All / Unselect All
    selectAllBtn.addEventListener('click', ()=> {
      boxes.forEach(b=>b.checked = true);
      updateBatch();
    });
    unselectAllBtn.addEventListener('click', ()=> {
      boxes.forEach(b=>b.checked = false);
      updateBatch();
    });

    // Batch select state update
    function updateBatch(){
      const any = Array.from(boxes).some(b=>b.checked);
      deleteSelBtn.disabled = !any;
      deleteSelBtn.classList.toggle('disabled', !any);
      downloadSelBtn.disabled = !any;
      downloadSelBtn.classList.toggle('disabled', !any);
    }
    boxes.forEach(b=>b.addEventListener('change', updateBatch));

    // Per-item delete
    gallery.querySelectorAll('.delete-item').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if(!confirm('Delete this item?')) return;
        const res = await fetch(btn.dataset.url, {
          method:'DELETE', credentials:'same-origin',
          headers:{ 'X-CSRFToken': csrfToken }
        });
        if(res.ok) btn.closest('.gallery-item').remove();
        else alert('Error deleting item: ' + res.status);
      });
    });

    // Batch delete
    deleteSelBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete selected?')) return;
      const sel = Array.from(boxes).filter(b=>b.checked);
      await Promise.all(sel.map(b=>{
        const item = b.closest('.gallery-item');
        return fetch(item.querySelector('.delete-item').dataset.url, {
          method:'DELETE', credentials:'same-origin',
          headers:{ 'X-CSRFToken': csrfToken }
        }).then(res=> res.ok ? item.remove() : null);
      }));
      updateBatch();
    });

    // Batch download
    downloadSelBtn.addEventListener('click', ()=>{
      const names = Array.from(boxes).filter(b=>b.checked)
                     .map(b=>b.closest('.gallery-item').dataset.filename);
      if(!names.length) return;
      const container = downloadSelForm.querySelector('.selected-inputs');
      container.innerHTML = '';
      names.forEach(n=>{
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = 'filenames'; inp.value = n;
        container.appendChild(inp);
      });
      downloadSelForm.submit();
    });

    // Batch delete all
    deleteAllBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete all?')) return;
      const res = await fetch(apiDeleteAll[prefix], {
        method:'DELETE', credentials:'same-origin',
        headers:{ 'X-CSRFToken': csrfToken }
      });
      if(res.ok) gallery.innerHTML = '';
      else alert('Failed to delete all: ' + res.status);
    });
  });

  // Preview modal logic
  const modal      = document.getElementById('preview-modal'),
        imgEl      = document.getElementById('preview-img'),
        videoEl    = document.getElementById('preview-video'),
        closeBtn   = document.getElementById('preview-close');

  document.querySelectorAll('.preview-item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const url = btn.dataset.url;
      if(/\.(mp4|webm|ogg)$/i.test(url)){
        imgEl.style.display = 'none';
        videoEl.src = url; videoEl.style.display = 'block';
      } else {
        videoEl.style.display = 'none';
        imgEl.src = url; imgEl.style.display = 'block';
      }
      modal.style.display = 'block';
    });
  });

  function closeModal(){
    modal.style.display = 'none';
    videoEl.pause();
  }
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

})();
</script>
{% endblock %}
