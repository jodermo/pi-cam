{% extends "controller/base.html" %}
{% load static %}

{% block title %}Media Browser{% endblock %}

{% block navigation %}
<div class="card navigation-card span-2">
  <div class="navigation-grid tabs" role="tablist">
    <button class="tab active" data-target="photos">Photos</button>
    <button class="tab" data-target="videos">Videos</button>
    <button class="tab" data-target="timelapse">Timelapse</button>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="media-container">

  {# PHOTOS #}
  <section id="photos" class="tab-content active">
    <div class="actions-card">
      <div class="layout-controls">
        <button id="photos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="photos-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="photos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
      <form id="photos-download-selected-form" method="post" action="{% url 'download_selected_photos' %}">
        {% csrf_token %}
        <input type="hidden" name="filenames" id="photos-filenames">
        <button id="photos-download-selected" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
      </form>
      <form method="post" action="{% url 'download_all_photos' %}">
        {% csrf_token %}
        <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
      </form>
      <button id="photos-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
    </div>
    <div id="photos-gallery" class="gallery grid-view">
      {% for photo in photos %}
      <div class="gallery-item" data-filename="{{ photo.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ photo.url }}" alt="{{ photo.filename }}">
        <div class="item-controls">
          <a href="{{ photo.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_photo' filename=photo.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}<p class="muted">No photos.</p>{% endfor %}
    </div>
  </section>

  {# VIDEOS #}
  <section id="videos" class="tab-content" hidden>
    <div class="actions-card">
      <div class="layout-controls">
        <button id="videos-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="videos-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="videos-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
      <form id="videos-download-selected-form" method="post" action="{% url 'download_selected_videos' %}">
        {% csrf_token %}
        <input type="hidden" name="filenames" id="videos-filenames">
        <button id="videos-download-selected" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
      </form>
      <form method="post" action="{% url 'download_all_videos' %}">
        {% csrf_token %}
        <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
      </form>
      <button id="videos-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
    </div>
    <div id="videos-gallery" class="gallery grid-view">
      {% for video in videos %}
      <div class="gallery-item" data-filename="{{ video.filename }}">
        <input type="checkbox" class="select-item">
        <video src="{{ video.url }}" controls></video>
        <div class="item-controls">
          <a href="{{ video.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_video' filename=video.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}<p class="muted">No videos.</p>{% endfor %}
    </div>
  </section>

  {# TIMELAPSE #}
  <section id="timelapse" class="tab-content" hidden>
    <div class="actions-card">
      <div class="layout-controls">
        <button id="tl-grid" class="btn-action active"><i class="fas fa-th-large"></i></button>
        <button id="tl-list" class="btn-action"><i class="fas fa-list"></i></button>
      </div>
      <div class="spacer"></div>
      <button id="tl-delete-selected" class="btn-action disabled"><i class="fas fa-trash"></i> Delete Selected</button>
      <form id="tl-download-selected-form" method="post" action="{% url 'download_selected_timelapse' %}">
        {% csrf_token %}
        <input type="hidden" name="filenames" id="tl-filenames">
        <button id="tl-download-selected" class="btn-action disabled"><i class="fas fa-download"></i> Download Selected</button>
      </form>
      <form method="post" action="{% url 'download_all_timelapse' %}">
        {% csrf_token %}
        <button class="btn-action"><i class="fas fa-download"></i> Download All</button>
      </form>
      <button id="tl-delete-all" class="btn-action"><i class="fas fa-trash-alt"></i> Delete All</button>
    </div>
    <div id="tl-gallery" class="gallery grid-view">
      {% for tl in timelapses %}
      <div class="gallery-item" data-filename="{{ tl.filename }}">
        <input type="checkbox" class="select-item">
        <img src="{{ tl.url }}" alt="{{ tl.filename }}">
        <div class="item-controls">
          <a href="{{ tl.url }}" download class="btn-action"><i class="fas fa-download"></i></a>
          <button class="btn-action delete-item" data-url="{% url 'api_delete_timelapse' filename=tl.filename %}">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      {% empty %}<p class="muted">No timelapse frames.</p>{% endfor %}
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}
<script>
;(function(){
  // TAB SWITCH
  document.querySelectorAll('.navigation-grid .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.navigation-grid .tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(sec=>sec.hidden = sec.id !== tab.dataset.target);
    });
  });

  // Helper to wire each section
  ['photos','videos','tl'].forEach(prefix=>{
    const gallery   = document.getElementById(prefix+'-gallery'),
          deleteSel = document.getElementById(prefix+'-delete-selected'),
          downloadSelForm = document.getElementById(prefix+'-download-selected-form'),
          downloadSelBtn  = document.getElementById(prefix+'-download-selected'),
          deleteAllBtn = document.getElementById(prefix+'-delete-all'),
          downloadAllBtnForms = {
            photos: '{% url "download_all_photos" %}',
            videos: '{% url "download_all_videos" %}',
            tl:     '{% url "download_all_timelapse" %}'
          };

    // layout toggles
    document.getElementById(prefix+'-grid').addEventListener('click', ()=> {
      gallery.classList.replace('list-view','grid-view');
      document.getElementById(prefix+'-grid').classList.add('active');
      document.getElementById(prefix+'-list').classList.remove('active');
    });
    document.getElementById(prefix+'-list').addEventListener('click', ()=> {
      gallery.classList.replace('grid-view','list-view');
      document.getElementById(prefix+'-list').classList.add('active');
      document.getElementById(prefix+'-grid').classList.remove('active');
    });

    // per-item deletes
    gallery.querySelectorAll('.delete-item').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if(!confirm('Delete this item?')) return;
        const res = await fetch(btn.dataset.url, {
          method:'DELETE',
          headers:{ 'X-CSRFToken':'{{ csrf_token }}' }
        });
        if(res.ok) btn.closest('.gallery-item').remove();
      });
    });

    // batch select handling
    const boxes = gallery.querySelectorAll('.select-item');
    function updateBatch() {
      const any = [...boxes].some(b=>b.checked);
      deleteSel.disabled = !any;
      downloadSelBtn.disabled = !any;
      deleteSel.classList.toggle('disabled', !any);
      downloadSelBtn.classList.toggle('disabled', !any);
    }
    boxes.forEach(b=>b.addEventListener('change', updateBatch));

    // batch delete-selected
    deleteSel.addEventListener('click', async ()=>{
      if(!confirm('Delete selected?')) return;
      const names = [...boxes].filter(b=>b.checked).map(b=>b.closest('.gallery-item').dataset.filename);
      const apiMap = {
        photos: '{% url "api_photo_list" %}',
        videos: '{% url "api_video_list" %}',
        tl:     '{% url "api_timelapse_list" %}'
      };
      const res = await fetch(apiMap[prefix], {
        method:'DELETE',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':'{{ csrf_token }}'
        },
        body: JSON.stringify({ filenames: names })
      });
      if(res.ok) window.location.reload();
    });

    // batch download-selected
    downloadSelForm.addEventListener('submit', e=>{
      const names = [...boxes].filter(b=>b.checked).map(b=>b.closest('.gallery-item').dataset.filename);
      document.getElementById(prefix+'-filenames').value = names;
    });

    // batch delete-all
    deleteAllBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete all?')) return;
      const apiMap = {
        photos: '{% url "api_delete_all_photos" %}',
        videos: '{% url "api_delete_all_videos" %}',
        tl:     '{% url "api_delete_all_timelapse" %}'
      };
      const res = await fetch(apiMap[prefix], {
        method:'DELETE',
        headers:{ 'X-CSRFToken':'{{ csrf_token }}' }
      });
      if(res.ok) window.location.reload();
    });
  });
})();
</script>
{% endblock %}
