{% extends "controller/base.html" %}
{% load static %}

{% block title %}Dashboard - USB Camera Controller{% endblock %}

{% block actions %}
{% if camera_list %}
  <div class="camera-source">
    <form id="camera-form" class="camera-select" method="post" action="{% url 'switch_camera' idx=0 %}">
      {% csrf_token %}
      <div class="select-container">
        <span>Camera Device:</span>
        <select id="camera-select" name="idx" onchange="controller.updateCameraForm(this.value);">
          {% for src in camera_list %}
            <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == active_index %}selected{% endif %}>
              {{ src }}
            </option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>
  <div class="header-bar">
    <div class="status-indicator" id="camera-status"></div>
  </div>
{% endif %}
{% if audio_inputs %}
<div class="audio-controls card">
  <audio
    id="live-audio"
    controls
    autoplay
    preload="none"
    src="{% url 'stream_audio' %}"
    type="audio/ogg"
  ></audio>

  <div class="select-container">
    <label for="audio-select">Audio Device:</label>
    <select id="audio-select">
      {% for dev in audio_inputs %}
        <option value="{{ forloop.counter0 }}"
          {% if forloop.counter0 == active_audio_idx %}selected{% endif %}>
          {{ dev }}
        </option>
      {% endfor %}
    </select>
  </div>

  <button class="btn-action" id="audio-switch-btn">
    <i class="fas fa-exchange-alt"></i> Switch Audio
  </button>
  <button class="btn-action" id="audio-restart-btn">
    <i class="fas fa-redo"></i> Restart Audio
  </button>
</div>
{% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-grid">

  <!-- Live Stream Card -->
  <div class="card stream-card">

    <div class="stream-wrapper">
      <img
        id="live-stream"
        class="stream"
        src="{{ stream_url }}"
        alt="Live camera stream"
      />
      <div class="stream-overlay">
        <div class="status-bar">
          <div id="current-time"></div>
          <div id="recording-status"></div>
          <div id="recording-duration"></div>
          <div id="last-video-block"></div>
        </div>
        <div id="recording-duration">
          {% if recording_elapsed %}{{ recording_elapsed }}{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" aria-hidden="true">
    <div class="modal-wrapper">
      <div class="modal-header">
        <button class="modal-close" id="close-settings">&times;</button>
        <h2>Camera Settings</h2>
      </div>
      <div class="modal-content">
        <div class="settings-grid">
          {% for setting in settings_fields %}
            <div class="setting-row">
              <label for="id_{{ setting.name }}">{{ setting.name|capfirst }}</label>
              <input
                id="id_{{ setting.name }}"
                type="number"
                min="0"
                max="255"
                value="{{ setting.value }}"
              />
              <input
                id="slider_{{ setting.name }}"
                type="range"
                min="0"
                max="255"
                value="{{ setting.value }}"
              />
              <button
                class="btn-small"
                onclick="controller.submitSetting('{{ setting.name }}'); return false;"
              >Set</button>
            </div>
          {% endfor %}
          <div class="setting-row checkbox-row">
            <label for="id_auto_exposure">Auto Exposure</label>
            <input
              id="id_auto_exposure"
              type="checkbox"
              {% if db_settings.auto_exposure %}checked{% endif %}
              onchange="controller.submitSetting('auto_exposure', this.checked ? 1 : 0)"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop"></div>
  </div>

  <div id="camera-error" class="camera-error" style="display:none;"></div>
  <div id="camera-recovered" class="camera-error recovered" style="display:none;">
    Camera recovered
  </div>



</div>



{% endblock %}

{% block navigation %}
  <!-- Action buttons: restart, snapshot, record, stop, settings -->
  <div class="card navigation-card span-2">
    <div class="navigation-grid">
      <button class="btn-action" onclick="controller.postAction('{% url 'restart' %}');">
        <i class="fas fa-sync-alt"></i>
      </button>
      <button
        class="btn-action"
        onclick="controller.postAction('{% url 'capture_photo' %}', true);"
      >
        <i class="fas fa-camera"></i>
      </button>
      <form id="record-form" method="post" action="{% url 'start_recording' %}">
        {% csrf_token %}
        <input type="hidden" name="audio_idx" id="record-audio-idx" value="{{ active_audio_idx }}">
        <button
          type="button"
          id="start-record"
          class="btn-action {% if is_recording %}active{% endif %}"
        >
          <i class="fas fa-dot-circle"></i>
        </button>
      </form>

      <button class="btn-action" onclick="controller.postAction('{% url 'stop_recording' %}');">
        <i class="fas fa-stop-circle"></i>
      </button>
      <button class="btn-action" id="open-settings">
        <i class="fas fa-cog"></i>
      </button>
    </div>

  </div>
{% endblock %}



{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const audioEl = document.getElementById('live-audio');
    const select  = document.getElementById('audio-select');
    const switchBtn  = document.getElementById('audio-switch-btn');
    const restartBtn = document.getElementById('audio-restart-btn');
    const csrftoken  = '{{ csrf_token }}';
    const base      = window.location.origin;
    
    function reloadStream() {
      // bust cache so audio tag reconnects
      audioEl.src = `{% url 'stream_audio' %}?_=${Date.now()}`;
      audioEl.load();
      audioEl.play().catch(() => {});
    }

    switchBtn?.addEventListener('click', async () => {
      const idx = select.value;
      try {
        const res = await fetch(`${base}/api/switch-audio/${idx}`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken }
        });
        if (!res.ok) throw await res.json();
        reloadStream();
      } catch (e) {
        alert('Failed to switch audio: ' + (e.error||e.detail||e));
      }
    });

    restartBtn?.addEventListener('click', async () => {
      // re-switch to same index to force ffmpeg restart
      const idx = select.value;
      try {
        const res = await fetch(`${base}/api/switch-audio/${idx}`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken }
        });
        if (!res.ok) throw await res.json();
        reloadStream();
      } catch (e) {
        alert('Failed to restart audio: ' + (e.error||e.detail||e));
      }
    });
  });
</script>
{% endblock %}