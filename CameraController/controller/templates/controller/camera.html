{% extends "controller/base.html" %}
{% load static %}

{% block title %}Dashboard - USB Camera Controller{% endblock %}

{% block actions %}
{% if camera_list %}
  <div class="camera-source">
    <form id="camera-form" class="camera-select" method="post" action="{% url 'switch_camera' idx=0 %}">
      {% csrf_token %}
      <select id="camera-select" name="idx" onchange="controller.updateCameraForm(this.value);">
        {% for src in camera_list %}
          <option value="{{ forloop.counter0 }}" {% if forloop.counter0 == active_index %}selected{% endif %}>
            {{ src }}
          </option>
        {% endfor %}
      </select>
    </form>
  </div>
  <div class="header-bar">
    <h1>USB Camera Controller</h1>
    <div class="status-indicator" id="camera-status"></div>
  </div>
{% endif %}
{% endblock %}

{% block content %}
<div class="dashboard-grid">

  <!-- Live Stream Card -->
  <div class="card stream-card">

    <div class="stream-wrapper">
      <img
        id="live-stream"
        class="stream"
        src="{{ stream_url }}"
        alt="Live camera stream"
      />
      <div class="stream-overlay">
        <div class="status-bar">
          <div id="current-time"></div>
          <div id="recording-status"></div>
          <div id="recording-duration"></div>
          <div id="last-video-block"></div>
        </div>
        <div id="recording-duration">
          {% if recording_elapsed %}{{ recording_elapsed }}{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal" aria-hidden="true">
    <div class="modal-wrapper">
      <div class="modal-header">
        <button class="modal-close" id="close-settings">&times;</button>
        <h2>Camera Settings</h2>
      </div>
      <div class="modal-content">
        <div class="settings-grid">
          {% for setting in settings_fields %}
            <div class="setting-row">
              <label for="id_{{ setting.name }}">{{ setting.name|capfirst }}</label>
              <input
                id="id_{{ setting.name }}"
                type="number"
                min="0"
                max="255"
                value="{{ setting.value }}"
              />
              <input
                id="slider_{{ setting.name }}"
                type="range"
                min="0"
                max="255"
                value="{{ setting.value }}"
              />
              <button
                class="btn-small"
                onclick="controller.submitSetting('{{ setting.name }}'); return false;"
              >Set</button>
            </div>
          {% endfor %}
          <div class="setting-row checkbox-row">
            <label for="id_auto_exposure">Auto Exposure</label>
            <input
              id="id_auto_exposure"
              type="checkbox"
              {% if db_settings.auto_exposure %}checked{% endif %}
              onchange="controller.submitSetting('auto_exposure', this.checked ? 1 : 0)"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop"></div>
  </div>

  <div id="camera-error" class="camera-error" style="display:none;"></div>
  <div id="camera-recovered" class="camera-error recovered" style="display:none;">
    Camera recovered
  </div>



</div>
{% endblock %}

{% block navigation %}
  <!-- Action buttons: restart, snapshot, record, stop, settings -->
  <div class="card navigation-card span-2">
    <div class="navigation-grid">
      <button class="btn-action" onclick="controller.postAction('{% url 'restart' %}');">
        <i class="fas fa-sync-alt"></i>
      </button>
      <button
        class="btn-action"
        onclick="controller.postAction('{% url 'capture_photo' %}', true);"
      >
        <i class="fas fa-camera"></i>
      </button>
      <button
        id="start-record"
        class="btn-action {% if is_recording %}active{% endif %}"
        onclick="controller.postAction('{% url 'start_recording' %}');"
      >
        <i class="fas fa-dot-circle"></i>
      </button>
      <button class="btn-action" onclick="controller.postAction('{% url 'stop_recording' %}');">
        <i class="fas fa-stop-circle"></i>
      </button>
      <button class="btn-action" id="open-settings">
        <i class="fas fa-cog"></i>
      </button>
    </div>

  </div>
{% endblock %}
